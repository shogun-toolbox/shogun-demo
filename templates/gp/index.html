{% extends "default.html" %}
{% block javascript %}
<script>
toy_data = [];
function Clear_action()
{
    svg.selectAll(".line")
        .transition()
        .duration(1000)
        .attr("d", start(json))
        .remove();
    svg.selectAll(".area")
        .remove();
    svg.selectAll(".dot").remove();
    new_points = {"points" : []};
    toy_data = [];
}

function GenerateToyData_action()
{
    $.ajax(
        {
            url:"create_toy_data",
            type: "POST",
            dataType: 'text',
            data: {csrfmiddlewaretoken: '{{ csrf_token }}',
                   amplitude: document.arguments.amplitude.value ,
                   frequency: document.arguments.frequency.value,
                   noise_level: document.arguments.noise_level.value},
            beforeSend: function(){$("#GenerateToyData").attr('disabled',true);},
            success: function(data){
                json = $.parseJSON(data)['data'];
                svg.selectAll(".dot").remove();
                toy_data = json;
                svg.selectAll(".dot")
                    .data(json)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("r", 1.5)
                    .attr("cx", function(d) { return x(d.x); })
                    .attr("cy", function(d) { return y(d.y); })
                    .style("fill", "red")
                    .style("stroke", "none");
                $("#GenerateToyData").attr('disabled', false);
            },
            error: function(){alert("Cannot connect to server");
                              $("#GenerateToyData").attr('disabled', false);}
        });
}
function TrainGP_action()
{
    var area_end = d3.svg.area()
            .x(function(d) { return x(d.x);})
            .y0(function(d) { return y(d.range_lower);})
            .y1(function(d) { return y(d.range_upper);});
    var end = d3.svg.line()
            .x(function (d) { return x(d.x); })
            .y(function (d) { return y(d.y); })
            .interpolate('basis');
    var start = d3.svg.line()
            .x(function (d) {return x(d.x); })
            .y(function (d) {return y(0); })
            .interpolate('basis');

    if (toy_data.length !=0)
        $.ajax(
            {
                url:"train",
                type: "POST",
                dataType: 'text',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    toy_data: JSON.stringify(toy_data),
                    noise_level: document.toy_data_generator.noise_level.value,
                    kernel_width: document.arguments.kernel_width.value
                },
                beforeSend: function(){$("#TrainGP").attr('disabled', true);},
                success: function(data){
                    json = $.parseJSON(data);
                    if (svg.selectAll(".line")[0].length == 0)
                        svg.append("path")
                        .attr("class", "line")
                        .attr("d", start(json))
                        .style("stroke-width", "2")
                        .style("stroke", "green")
                        .style("fill", "none");
                    svg.selectAll(".line")
                        .transition().duration(1000)
                        .attr("d", end(json));
                    svg.selectAll(".area")
                        .remove();
                    svg.append("path")
                        .datum(json)
                        .attr("class", "area")
                        .attr("d", area_end(json))
                        .style("fill", "rgba(128, 128, 128, 0.25)");
                    $("#TrainGP").attr('disabled', false);
                },
                error: function(){
                    alert("Error Generated!");
                    $("#TrainGP").attr('disabled', false);
                }
            });
    else{
        alert("Sorry, there's no dots to train, generate some, pls");
    }
}
</script>
{% endblock %}
